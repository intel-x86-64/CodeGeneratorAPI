name: CMake Build - Arch Linux

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Cache pacman packages
      uses: actions/cache@v3
      with:
        path: /var/cache/pacman/pkg
        key: ${{ runner.os }}-pacman-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-pacman-
      
    - name: Install dependencies
      run: |
        pacman -Sy --noconfirm
        pacman -S --noconfirm --needed \
          base-devel \
          cmake \
          openssl \
          asio \
          zxing-cpp
        
    - name: Build project
      run: |
        mkdir -p build
        cd build
        cmake -DCMAKE_BUILD_TYPE=Release ..
        make -j$(nproc)
        
    - name: Verify build
      run: |
        [ -f build/server ] && echo "✅ Build successful" || (echo "❌ Build failed" && exit 1)
